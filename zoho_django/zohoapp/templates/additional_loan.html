<!-- RIJIN -->
{% extends 'base.html' %}
{% block content %}
{% load static %}

<style>
    .modal{
        z-index: 9999;
        overflow: scroll;
}

    input[type="text"],
    input[type="date"],
    input[type="number"],
    input[type="email"],
    input[type="file"],
    .gen-info textarea,
    .gen-info select,
    .data select,
    .data option,
    .gen-info option {
        color: rgb(7, 7, 7);
        border: 1px solid rgb(0, 0, 0);
    }

    .gen-info .left {
        padding-right: 2rem;
    }


    .action-button {
        display: flex;
        align-items: center;
        /* justify-content: center; */
    }

    .action-button button {
        width: 8vw;
        font-size: 1.2vw;
        margin: 0.5rem .3rem;
    }

    label {
        font-size: 1.2vw;
    }

    .containerprof {

        position: relative;

    }

</style>

<style>

    input[type="text"],
    input[type="date"],
    input[type="number"],
    input[type="email"],
    input[type="file"],
    .gen-info textarea,
    .gen-info select,
    .data select,
    .data option,
    .gen-info option {
        color: rgb(7, 7, 7);
        border: 1px solid rgb(0, 0, 0);
    }

    .gen-info .left {
        padding-right: 2rem;
    }


    .action-button {
        display: flex;
        align-items: center;
        /* justify-content: center; */
    }

    .action-button button {
        width: 8vw;
        font-size: 1.2vw;
        margin: 0.5rem .3rem;
    }

    label {
        font-size: 1.2vw;
    }

    .containerprof {

        position: relative;

    }

    .fixed-width-label {
        display: inline-block;
        width: 150px; /* Set your desired fixed width */
        margin-right: 10px; /* Add margin for spacing if needed */
    }

    
</style>
<!-- jQuery library -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- jQuery UI library -->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<section>
    <div class="containerprof p-5">
        <div class="header pb-5">
            <h2 class="mb-0 text-uppercase text-right">Additional Loan</h2>
            <hr>
            {% for message in messages %}
            <h5>
                <div class="alert alert-danger message">
                    {{ message }}
                </div>
            </h5>
        {% endfor %}
        </div>

        <form method="POST" action="{% url 'add_additional_loan' repay.loan.id %}" id="myForm" onsubmit="return validateform()">
            {% csrf_token %}
            <div class="row">
                <div class="data">

                    
            
            
                <script>
                    function clearErrorMessage() {
                        var errorDiv = document.getElementById('error-message');
                        if (errorDiv) {
                            errorDiv.style.display = 'none';
                        }
                    }
                </script>
                
                
                
                    <div class="row pb-3">
                        <div class="col-md-3">
                            <label for="">Balance Loan Amount</label>
                        </div>
                        <div class=" col-5">
                            <input type="number" class="form-control text-dark bg-light" name="bamnt" id="bamnt" value="{{repay.balance}}" readonly >
                        </div>
                    </div>
                    <div class="row pb-3">
                        <div class="col-3">
                            <label for="">New Loan Amount</label>
                        </div>
                        <div class="col-5">
                            <input type="number" class="form-control text-dark bg-light" name="namnt" id="namnt" value="0" onchange="gettotal()" required>
                        </div>
                    </div>
                    <div class="row pb-3">
                        <div class="col-3">
                            <label for="">Total Loan Amount</label>
                        </div>
                        <div class="col-5">
                            <input type="number" class="form-control text-dark bg-light" name="total" id="total" value="{{repay.balance}}" readonly>
                        </div>
                    </div>
                    <div class="row pb-3">
                        <div class="col-3">
                            <label for="">Adjustment Date</label>
                        </div>
                        <div class="col-5">
                            <input type="date" class="form-control text-dark bg-light" name="adjdate" id="adjdate" value="{{today}}">
                        </div>
                    </div>
                    
                    <div class="row pb-3">
                        <div class="col-3">
                            <label for="">Payment Method</label>
                        </div>
                        <div class="col-5">
                            <select class="form-control text-dark bg-light" name="payment_method" id="payment_method" required>
                                <option value="" selected hidden>Select</option>
                                <option value="Cash">Cash</option>
                                <option value="UPI">UPI</option>
                                <option value="Cheque">Cheque</option>
                                {% for item in bank %}
                                <option value="{{item.name}}">{{item.name}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    
                    <div class="row pb-3" id="chequediv" style="display: none;">
                        <div class="col-3">
                        <label for="date2">Cheque ID</label>
                        </div>
                
                        <div class="col-5">
                            <input type="text" class="form-control text-black bg-white" name="cheque_id" id="cheque_id">
                        </div>
                    </div>  
                
                    <div class="row pb-3" id="upidiv" style="display: none;">
                        <div class="col-3">
                        <label for="date2">UPI ID</label>
                        </div>
                
                        <div class="col-5">
                            <input type="text" class="form-control text-black bg-white" name="upi_id" id="upi_id" >
                        </div>
                    </div>  
                
                    <div class="row pb-3" id="bnkdiv" style="display: none;">
                        <div class="col-3">
                        <label for="date2">Bank Account</label>
                        </div>
                
                        <div class="col-5">
                        <input type="text" class="form-control text-black bg-white" name="bnk_id" id="bnk_id" readonly>
                        </div>
                    </div>  

                </div>


                    
                    <script>
                        function showAdditionalFields() {
                            var paymentMethod = document.getElementById('payment_method').value;
                            var percentageWiseFields = document.getElementById('percentageWiseFields');
                            var percentageWiseMonthlyFields = document.getElementById('percentageWiseMonthlyFields');
                            var monthlyCuttingAmountLabel = document.querySelector('[for="monthly_cutting_amount"]');
                            var monthlyCuttingAmountField = document.getElementById('monthly_cutting_amount');
                            if (paymentMethod === 'percentage_wise') {
                                percentageWiseFields.style.display = 'block';
                                percentageWiseMonthlyFields.style.display = 'block';
                                monthlyCuttingAmountLabel.style.display = 'block';
                                monthlyCuttingAmountField.style.display = 'block';
                            } else if (paymentMethod === 'amount_wise') {
                                percentageWiseFields.style.display = 'none';
                                percentageWiseMonthlyFields.style.display = 'block';  // Show the "Monthly Cutting Amount" field
                                monthlyCuttingAmountLabel.style.display = 'block';
                                monthlyCuttingAmountField.style.display = 'block';
                                document.getElementById('percentage').value = '';
                                document.getElementById('monthly_cutting_amount').value = '';
                            } else {
                                percentageWiseFields.style.display = 'none';
                                percentageWiseMonthlyFields.style.display = 'none';
                                monthlyCuttingAmountLabel.style.display = 'none';
                                monthlyCuttingAmountField.style.display = 'none';
                            }
                        }
                        
                    </script>
                    
                    
                    
                                 <!-- Error message for cutting amount validation -->


                        </div>

                        
                        
                          <!-- Action buttons -->
            <div class="action-button">
                <button class="btn" type="submit" style="background-color: chocolate;">Submit</button>
                <button class="btn" type="reset" style="background-color: chocolate;">Cancel</button>
            </div>
            <div class="text-center">
                <!-- ... (Message alerts) ... -->
            </div>
        </form>
    </div>

          
    <div class="modal fade" id="newvendor">
        <div class="modal-dialog modal-xl">
          <div class="modal-content" style="background: rgb(32, 35, 37);border-radius: 20px;">
            <div class="modal-header " style="background: rgb(32, 35, 37);">
                <h3 class="m-3 text-uppercase">New Employee</h3>
                <button type="button" class="btn close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" style="font-size: x-large;">&times;</span>
                </button>
                   
                </div>
                <div class="modal-body" style="background: rgb(32, 35, 37);">
                    <div class="card p-3 m-3">
                        <form action="{% url 'createpayroll' %}" method="post" class="needs-validation" novalidate autocomplete="off" id="modalVendor">
                    <div class="row">
                        <div class="data col-6 col-lg-6 col-md-6 col-sm-12">
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Title</label>
                                </div>
                                <div class=" col-6">
                                    <select class="form-control text-dark bg-light" name="title" id="title" required>
                                        <option value="" selected hidden>Select</option>
                                        <option value="Mr">Mr</option>
                                        <option value="Mrs">Mrs</option>
                                        <option value="Miss">Miss</option>
                                        <option value="Ms">Ms</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">First Name</label>
                                </div>
                                <div class="col-6">
                                    <input type="text" class="form-control text-dark bg-light" name="fname" id="fname" required>
                                </div>
                            </div>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Last Name</label>
                                </div>
                                <div class="col-6">
                                    <input type="text" class="form-control text-dark bg-light" name="lname" id="lname" required>
                                </div>
                            </div>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Alias</label>
                                </div>
                                <div class="col-6"><input type="text" class="form-control text-dark bg-light"
                                        name="alias" id="alias">
                                </div>
                            </div>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Date of joining</label>
                                </div>
                                <div class="col-6">
                                    <input type="date" class="form-control text-dark bg-light" name="joindate2" id="joindate2" required>
                                    
                                </div>
                            </div>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="sdate">Salary Date</label>
                                </div>
                                <div class="input-container col-6">
                                    <select class="form-control text-dark bg-light bg-light" name="salarydate" id="sdate" required>
                                        <option value="" selected hidden>Select</option>
                                        <option value="1-10">1-10</option>
                                        <option value="10-15">10-15</option>
                                        <option value="15-31">15-31</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Define salary details</label>
                                </div>
                                <div class="col-6">
                                    <select class="form-control text-dark bg-light" name="saltype" id="sal" onchange="salFunction()" required>
                                        <option value="" selected hidden>Select</option>
                                        <option value="Fixed">Fixed</option>
                                        <option value="Fixed">Temporary</option>
                                        <option value="Variable">Time Based</option>
                                    </select>
                                </div>
                            </div>
        
                            <div id="fixed" style="display: none;">
                                <div class="row pb-3">
                                    <div class="col-6">
                                        <label for="">Salary Amount</label>
                                    </div>
                                    <div class="col-6"><input type="number" class="form-control text-dark bg-light" name="fsalary"
                                            id="fsalary" required>
                                    </div>
                                </div>
        
                            </div>
                            <div id="variable" style="display: none;">
                                <div class="row pb-3">
                                    <div class="col-6">
                                        <label for="">Amount per Hour</label>
                                    </div>
                                    <div class="col-6"><input type="number" class="form-control text-dark bg-light" name="amnt"
                                            id="amnt" required></div>
                                </div>
                                <div class="row pb-3">
                                    <div class="col-6">
                                        <label for="">Total working Hours</label>
                                    </div>
                                    <div class="col-6"><input type="number" class="form-control text-dark bg-light" name="hours"
                                            id="hours" onkeyup="calculateAmount()" required></div>
                                </div>
                                <div class="row pb-3">
                                    <div class="col-6">
                                        <label for="">Salary Amount</label>
                                    </div>
                                    <div class="col-6"><input type="number" class="form-control text-dark bg-light" name="vsalary"
                                            id="vsalary" required>
                                    </div>
                                </div>
                            </div>
        
        
                        </div>
                        <div class="image col-6 col-lg-6 col-md-6 col-sm-12">
        
                            <div class="row">
                                <div class="col-5 col-lg-5 col-md-10 col-sm-12 text-center">
                                    <label for="">Upload Image</label>
                                </div>
                                <div class="col-7 col-lg-7 col-md-10 col-sm-12">
                                    <label for="image-input">
                                        <img class="img-fluid" src="{% static 'images/payrollimg.png' %}" alt="" width="190px"
                                            height="200px" id="img"
                                            style="background-color: rgba(156, 156, 156, 0.267); border-radius: 30px;">
                                    </label>
                                    <input id="image-input" type="file" name="file" class="form-control" accept="image/*"
                                        onchange="loadFile(event)" style="display: none;">
        
                                </div>
        
                            </div>
        
        
                        </div>
                        <script>
                            var loadFile = function (event) {
                                var reader = new FileReader();
                                reader.onload = function () {
                                    var output = document.getElementById('img');
                                    output.src = reader.result;
                                };
                                reader.readAsDataURL(event.target.files[0]);
                            };
        
                        </script>
                    </div>
        
                    <div class="gen-info row pt-5">
                        <div class="left col-6 col-lg-6 col-md-6 col-sm-12">
                            <h4 class="text-center py-2">General information</h4>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Employee Number</label>
                                </div>
                                <div class="col-6"><input type="text" class="form-control text-dark bg-light" name="empnum" id="empnum"
                                        onkeyup="empValidation(document.getElementById('empnum'))" required>
                                </div>
                            </div>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Designation</label>
                                </div>
                                <div class="col-6"><input type="text" class="form-control text-dark bg-light" name="designation" id="designation"
                                        required></div>
                            </div>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Location</label>
                                </div>
                                <div class="col-6"><input type="text" class="form-control text-dark bg-light" name="location" id="location" required>
                                </div>
                            </div>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Gender</label>
                                </div>
                                <div class="col-6">
                                    <select class="form-control text-dark bg-light" name="gender" id="dropId3" required>
                                        <option value="" selected hidden>Select</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Transgender">Transgender</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Date of Birth</label>
                                </div>
                                <div class="col-6"><input type="date" class="form-control text-dark bg-light" name="dob" id="dob" onchange="calculateAge()" required></div>
                            </div>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Age</label>
                                </div>
                                <div class="col-6"><input type="number" class="form-control text-dark bg-light" name="age" id="age" readonly></div>
                            </div>
                            
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Blood Group</label>
                                </div>
                                <div class="col-6">
                                    <select class="form-control text-dark bg-light" id="blood" name="blood" required>
                                        <option value="" selected hidden>Select</option>
                                        <option value="A+">A+</option>
                                        <option value="A-">A-</option>
                                        <option value="B+">B+</option>
                                        <option value="B-">B-</option>
                                        <option value="O+">O+</option>
                                        <option value="O-">O-</option>
                                        <option value="AB+">AB+</option>
                                        <option value="AB-">AB-</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Father's Name/Mother's Name</label>
                                </div>
                                <div class="col-6"><input type="text" class="form-control text-dark bg-light" name="fm_name"  id="fm_name">
                                </div>
                            </div>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Spouse's Name</label>
                                </div>
                                <div class="col-6"><input type="text" class="form-control text-dark bg-light" name="s_name" id="s_name"></div>
                            </div>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Permanent Address</label>
                                </div>
                                <div class="col-6">
                                    <textarea class="form-control text-dark bg-light mb-2 pt-0" name="paddress" id="padrs1"
                                        required onkeyup="clearaddreass(this.id)"></textarea>
                                    <textarea class="form-control text-dark bg-light pt-0" name="paddress2" id="padrs2" onkeyup="clearaddreass(this.id)"></textarea>
                                </div>
                            </div>
                            <div class="row pb-4">
                                <div class="col-6">
                                    <label for="">Temporary Address</label>
                                </div>
                                <div class="col-6">
                                    <input class="mx-2" type="checkbox" id="filladdress" name="filladdress"><label
                                        style="font-size: .8rem;">Same as permanent address</label>
                                    <textarea class="form-control text-dark bg-light mb-2 pt-0" name="address" id="adrs1"
                                        required onkeyup="clearaddreass(this.id)"></textarea>
                                    <textarea class="form-control text-dark bg-light pt-0" name="address2" id="adrs2" onkeyup="clearaddreass(this.id)"></textarea>
                                </div>
                            </div>
        
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Contact Number</label>
                                </div>
                                <div class="col-6"><input type="number" class="form-control text-dark bg-light" name="phone" id="phone"
                                        required
                                        onkeyup="phoneValidate(document.getElementById('phone'),document.getElementById('pherror'))">
                                    <div id="pherror" class="text-danger"></div>
                                </div>
                            </div>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Emergency Contact Number</label>
                                </div>
                                <div class="col-6"><input type="number" class="form-control text-dark bg-light" name="ephone" id="ephone"
                                        onkeyup="phoneValidate(document.getElementById('ephone'),document.getElementById('epherror'))">
                                    <div id="epherror" class="text-danger"></div>
                                </div>
                            </div>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Email</label>
                                </div>
                                <div class="col-6"><input type="email" class="form-control text-dark bg-light" name="email2" id="email2"
                                        required onkeyup="emailvalidate()">
                                    <div id="error" class="text-danger"></div>
                                </div>
                            </div>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Attachments</label>
                                </div>
                                <div class="col-6">
                                    <input class="form-control" id="file-upload" type="file" name="attach"
                                        style="background: transparent;">
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-6 col-md-6 col-sm-12 pt-3 mt-2">
                            <br>
                            <div class="row pb-4">
                                <div class="col-6">
                                    <label for="">Provide Bank Details</label>
                                </div>
                                <div class="col-6"><select class="form-control text-dark bg-light" name="bank" id="dropId"
                                        onchange="bankdisplay()" required>
                                        <option value="" selected hidden>Select</option>
                                        <option value="1">Yes</option>
                                        <option value="0">No</option>
                                    </select>
                                </div>
                            </div>
                            <div class="bank" id="bank" style="display: none;">
                                <h4 class="text-center py-2">Bank information</h4>
                                <div class="row pb-3">
                                    <div class="col-6">
                                        <label for="">Account Number</label>
                                    </div>
                                    <div class="col-6"><input type="number" class="form-control text-dark bg-light" name="acc_no"
                                            id="acc_no" pattern="[0-9]{15}" required></div>
                                </div>
                                <div class="row pb-3">
                                    <div class="col-6">
                                        <label for="">IFSC</label>
                                    </div>
                                    <div class="col-6"><input type="text" class="form-control text-dark bg-light" name="ifsc" id="ifsc" required>
                                    </div>
                                </div>
                                <div class="row pb-3">
                                    <div class="col-6">
                                        <label for="">Name of Bank</label>
                                    </div>
                                    <div class="col-6"><input type="text" class="form-control text-dark bg-light" name="b_name"
                                            id="b_name" required></div>
                                </div>
                                <div class="row pb-3">
                                    <div class="col-6">
                                        <label for="">Branch Name</label>
                                    </div>
                                    <div class="col-6"><input type="text" class="form-control text-dark bg-light" name="branch"
                                            id="branch" required> </div>
                                </div>
                                <h5 class="text-center py-1">For Banking</h5>
                                <div class="row pb-3">
                                    <div class="col-6">
                                        <label for="">Transaction Type</label>
                                    </div>
                                    <div class="col-6">
                                        <select class="form-control text-dark bg-light" name="ttype" id="ttype" required>
                                            <option value="" selected hidden>Select</option>
                                            <option value="ATM">ATM</option>
                                            <option value="Cash">Cash</option>
                                            <option value="Check">Check</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">TDS Applicable</label>
                                </div>
                                <div class="col-6">
                                    <select class="form-control text-dark bg-light" name="tds" id="tds" onchange="tdsFunction()"
                                        required>
                                        <option value="" selected hidden>Select</option>
                                        <option value="1">Yes</option>
                                        <option value="0">No</option>
                                    </select>
                                </div>
                            </div>
                            <div id="tds-div" style="display: none;">
                                <div class="row pb-3">
                                    <div class="col-6">
                                        <label for="">Percentage/Amount</label>
                                    </div>
                                    <div class="col-6">
                                        <select class="form-control text-dark bg-light" name="pora" id="pora" onchange="tdsFunction2()" required>
                                            <option value="" selected hidden>Select</option>
                                            <option value="Percentage">Percentage</option>
                                            <option value="Amount">Amount</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="p" style="display: none;">
                                    <div class="row pb-3">
                                        <div class="col-6">
                                            <label for="">Percentage</label>
                                        </div>
                                        <div class="col-6"><input type="number" class="form-control text-dark bg-light" name="pcnt"
                                                id="pcnt" required>
                                        </div>
                                    </div>
                                </div>
                                <div id="a" style="display: none;">
                                    <div class="row pb-3">
                                        <div class="col-6">
                                            <label for="">Amount</label>
                                        </div>
                                        <div class="col-6"><input type="number" class="form-control text-dark bg-light" name="amnt"
                                                id="amnt" required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <h4 class="text-center py-2">Statutary information</h4>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Income Tax Number</label>
                                </div>
                                <div class="col-6"><input type="number" class="form-control text-dark bg-light" name="itn"  id="itn"></div>
                            </div>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Aadhar Number</label>
                                </div>
                                <div class="col-6"><input type="text" class="form-control text-dark bg-light" name="an" id="an"
                                     required></div>
                            </div>
                            <script>
                                const input = document.getElementById("an");
                                input.addEventListener("input", () => input.value = formatNumber(input.value.replaceAll(" ", "")));
        
                                const formatNumber = (number) => number.split("").reduce((seed, next, index) => {
                                    if (index !== 0 && !(index % 4)) seed += " ";
                                    return seed + next;
                                }, "");
                            </script>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">Universal Account Number(UAN)</label>
                                </div>
                                <div class="col-6"><input type="number" class="form-control text-dark bg-light" name="uan" id="uan" required></div>
                            </div>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">PF Account Number(PFN)</label>
                                </div>
                                <div class="col-6"><input type="number" class="form-control text-dark bg-light" name="pfn" id="pfn" required></div>
                            </div>
                            <div class="row pb-3">
                                <div class="col-6">
                                    <label for="">PR Account Number(PRAN)</label>
                                </div>
                                <div class="col-6"><input type="text" class="form-control text-dark bg-light" name="pran" id="pran" required></div>
                            </div>
                        </div>
                    </div>
        
                    <hr>
                    
                  <div class="row">
                    <div class="col-md-4">
                      <div class="d-flex">
                        <button class="btn" style="background-color: chocolate;"
                        type="button" data-dismiss="modal" id="vendorSave">Submit
                        </button> 
  
                        <button type="button" class="close btn"  style="background-color: chocolate; margin-left: 2vh;"
                          data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">Cancel</span>
                        </button>
                      </div>
                    </div>
                    <div class="col-md-6"></div>
                    <!-- <div class="col-md-4"></div> -->
                  </div>
                </form>
                    </div>
                </div>
            </div>
        </div>  
      </div>  

      <div class="modal fade" id="newduration" style="margin-top: 7vh;">
        <div class="modal-dialog ">
          <div class="modal-content" style="background: rgb(32, 35, 37);border-radius: 20px;">
            <div class="modal-header">
              <h5 class="modal-title" id="excelModalLabel">Add Loan Duration</h5>
              <button type="button" class="btn close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true" style="font-size: x-large;">&times;</span>
              </button>
            </div>
            <div class="modal-body" style="background: rgb(32, 35, 37);">
              <div class="card">
                <form action="" method="post" class="needs-validation" novalidate autocomplete="off" id="durationform">
                  {% csrf_token %}
                  <div class="form-group mt-3" style="margin-left: 2vh;">
                    <div class="row">
                        <div class="col-md-3 mt-2">
                            <label for="lday" style="font-size: medium;">Enter Day </label> <br><br>
                        </div>
                        <div class="col-md-8" style="margin-left: 2vh;">
                            <input type="number" class="form-control text-dark bg-white" name="lday" id="lday">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mt-2">
                            <label for="ldur" style="font-size: medium;">Enter Duration </label> <br><br>
                        </div>
                        <div class="col-md-8" style="margin-left: 2vh;">
                            <select class="form-control text-dark bg-white" name="ldur" id="ldur">
                                <option value="" selected hidden>Select</option>
                                <option value="Month">Month</option>
                                <option value="Year">Year</option>
                            </select>
                        </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                      <button type="button" class="btn text-center pt-2 btn-outline-warning" data-dismiss="modal" id="durationsave">Submit</button>
                    <button type="button" class="btn text-center pt-2 btn-outline-warning" data-dismiss="modal">Close</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>  
      </div>  
      {% if error_message %}
                    <div class="alert alert-danger" id="error-message">
                    
                        {{ error_message }}
                    </div>
                {% endif %}           
      
      <div class="text-center">
                        {% for message in messages %}
                        <div class="alert alert-success alert-dismissible fade show" role="alert" id="alert">
                            <strong>{{message}}</strong>
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </form>
        
            </div>
        
        
        
        </section>



        <script>
            function validateform() {
                var pay_method = document.getElementById('payment_method').value;
                var cheque_id = document.getElementById('cheque_id').value;
                var upi_id = document.getElementById('upi_id').value;
        
                if (pay_method === ''){
                    alert('Please select a Payment Method');
                    return false;
                }else if(pay_method === 'Cheque'){
                    if (cheque_id === ''){
                        alert('Add a cheque number');
                        return false;
                    }
                }else if(pay_method === 'UPI'){
                    if (upi_id === ''){
                        alert('Add a UPI number');
                        return false;
                    }
                }
    
                return true; 
            }
        </script>

<script>
    function gettotal(){
        bamnt = parseFloat($('#bamnt').val())
        namnt = parseFloat($('#namnt').val())
        if(namnt < 0 ){
            $('#namnt').val(0)
            $('#total').val('{{repay.balance}}')
            alert('Amount cannot be Negative')
        }else{
            $('#total').val(bamnt+namnt)
        }
    }
</script>
        
<script>
    $(document).ready(function() {
      $("#payment_method").change(function() {
        var x=$('#payment_method').val();
        if(x==='Cash'){
          $('#chequediv').hide()
          $('#bnkdiv').hide()
          $('#upidiv').hide()
          document.getElementById('cheque_id').value=null
          document.getElementById('upi_id').value=null
        }else if(x==='Cheque'){
          $('#chequediv').show()
          $('#bnkdiv').hide()
          $('#upidiv').hide()
          document.getElementById('upi_id').value=null
        }else if(x==='UPI'){
          $('#upidiv').show()
          $('#bnkdiv').hide()
          $('#chequediv').hide()
          document.getElementById('cheque_id').value=null
        }else{
          $('#bnkdiv').show()
          $('#chequediv').hide()
          $('#upidiv').hide()
          document.getElementById('cheque_id').value=null
          document.getElementById('upi_id').value=null

          $.ajax({
              type: "GET",
              url: "{% url 'bankdata' %}",
              data: {
                  id: x,
              },
              success: function (response) {
                  data = response.bank
                  document.getElementById('cheque_id').value=null
                  document.getElementById('upi_id').value=null
                  document.getElementById("bnk_id").value = data
              }
          });
        }
      });
    });
</script>

        <script>
            document.getElementById('loan_issue_date').addEventListener('change', updateExpDate);
            

            function updateExpDate() {
                var selectedDate = new Date( document.getElementById('loan_issue_date').value);
                var newdate = new Date(selectedDate);
                var loandur = document.getElementById('duration').value;
                ldays = parseInt(loandur.split(' ')[0])
                lduration = loandur.split(' ')[1]
                if (lduration == 'Year' || lduration == 'Years'){
                    // Add 20 days to the start date
                    ldays = ldays * 365
                    newdate.setDate(selectedDate.getDate() + ldays);

                    // Format the end date as 'YYYY-MM-DD' for input field
                    var loandate = newdate.toISOString().split('T')[0];

                    // Set the calculated end date in the end_date input field
                    document.getElementById('loan_expiry_date').value = loandate;
                }else{

                    ldays = ldays * 30
                    newdate.setDate(selectedDate.getDate() + ldays);

                    // Format the end date as 'YYYY-MM-DD' for input field
                    var loandate = newdate.toISOString().split('T')[0];

                    // Set the calculated end date in the end_date input field
                    document.getElementById('loan_expiry_date').value = loandate;       

                }
            }

            $(document).on('change','#duration', function(){
                var selectedDate = new Date(document.getElementById('loan_issue_date').value);
                if(isNaN(selectedDate)){
                    alert('Select an Loan Issue Date')
                    document.getElementById('duration').value = ''
                }
            }
            )

        </script>

        <script>
            $(document).on("click", "#durationsave", function () {
                days = $("#lday").val()
                durs = $("#ldur").val()
            if(days != 1){
                if(durs == 'Month'){
                    durs = 'Months'
                }else{
                    durs = 'Years'
                }
            }

                
    // Start an AJAX POST request
    $.ajax({
        // Specify the request type as POST
        type: "POST",
        // Define the URL where the request will be sent (replace with your URL)
        url: "{% url 'create_loan_duration' %}",
        // Pass the data to be sent to the server in the form of key-value pairs
        data: {
            days:days,
            durs:durs,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        // Define a function to execute when the request is successful
        success: function (response) {
            
            document.getElementById("durationform").reset();
            reload_duration();
            
        },
    });
});

function reload_duration() {
    $.ajax({
        url: "{% url 'loan_duration' %}",
        type: "GET",
        dataType: "json",
        data: $(this).serialize(),
        csrfmiddlewaretoken: '{{ csrf_token }}',
        success: function(data) {
            var dropdown = $('#duration');
            dropdown.empty();

            dropdown.append($('<option value="" hidden selected>Select</option>'));
            dropdown.append($('<option value="6 Months">6 Months</option>'));
            dropdown.append($('<option value="1 Year">1 Year</option>'));
      $.each(data, function(key, value) {
          dropdown.append($('<option></option>').attr('value', key).text(value).val(key));
            });

            
        },
        error: function(xhr, status, error) {
            console.error(xhr.responseText);
        }
    });
}

        </script>

        <script>
                function calculateAge() {
        const dobInput = document.getElementById("dob");
        const selectedDateOfBirth = new Date(dobInput.value);
        const currentDate = new Date();
        const age = currentDate.getFullYear() - selectedDateOfBirth.getFullYear();
        const ageInput = document.getElementById("age");
        ageInput.value = age;
    }
        </script>
        
        <script>

            


           // When the element with id "vendorSave" is clicked
$(document).on("click", "#vendorSave", function () {
    var emailValue = $("#email").val();
    console.log("Email Value: " + emailValue);


    // Get the date values from your input fields
var joindate2Value = $("#joindate2").val();
var dobValue = $("#dob").val();

// Create Date objects from the input values (assuming your input values are in a valid date format)
var joindate2Date = new Date(joindate2Value);
var dobDate = new Date(dobValue);

// Check if the Date objects are valid
if (!isNaN(joindate2Date.getTime()) && !isNaN(dobDate.getTime())) {
    // Format the dates in YYYY-MM-DD format
    var joindate2Formatted = joindate2Date.toISOString().split('T')[0];
    var dobFormatted = dobDate.toISOString().split('T')[0];
}
    // Start an AJAX POST request
    $.ajax({
        // Specify the request type as POST
        type: "POST",
        // Define the URL where the request will be sent (replace with your URL)
        url: "{% url 'createpayroll2' %}",
        // Pass the data to be sent to the server in the form of key-value pairs
        data: {
            // Retrieve the value from an element with id "title" and send it with the key "title"
            title: $("#title").val(),
            // Retrieve the value from an element with id "fname" and send it with the key "firstname"
            fname: $("#fname").val(),
            // Retrieve the value from an element with id "lname" and send it with the key "lastname"
            lname: $("#lname").val(),
            alias: $("#alias").val(),
            joindate2: $("#joindate2").val(),
            salarydate: $("#sdate").val(),
            saltype: $("#sal").val(),
            fsalary: $("#fsalary").val(),
            vsalary: $("#vsalary").val(),
            amnt: $("#amnt").val(),
            file: $("#image-input").val(),
            
            hours: $("#hours").val(),
            empnum: $("#empnum").val(),
            designation: $("#designation").val(),
            location: $("#location").val(),
            gender: $("#dropId3").val(),
            dob: $("#dob").val(),
            
            blood: $("#blood").val(),
            fm_name: $("#fm_name").val(),
            s_name: $("#s_name").val(),
            paddress: $("#padrs1").val(),
            paddress2: $("#padrs2").val(),
            address: $("#adrs1").val(),
            address2: $("#adrs2").val(),
            filladdress: $("#filladdress").prop("checked"),
            phone: $("#phone").val(),
            ephone: $("#ephone").val(),
            email2: $("#email2").val(),
            attach: $("#file-upload").val(),
            bank: $("#dropId").val(),
            acc_no: $("#acc_no").val(),
            ifsc: $("#ifsc").val(),
            b_name: $("#b_name").val(),
            branch: $("#branch").val(),
            ttype: $("#ttype").val(),
            tds: $("#tds").val(),
            pora: $("#pora").val(),
            pcnt: $("#pcnt").val(),
            amnt: $("#amnt").val(),
            itn: $("#itn").val(),
            an: $("#an").val(),
            uan: $("#uan").val(),
            pfn: $("#pfn").val(),
            pran: $("#pran").val(),
            age: $("#age").val(),
            joindate2: joindate2Formatted,
            dob: dobFormatted,
            
            csrfmiddlewaretoken: '{{ csrf_token }}'
            
        },
        // Define a function to execute when the request is successful
        success: function (response) {
            
            document.getElementById("modalVendor").reset();
            reloadVendor();
            
        },
    });
});

function reloadVendor() {
    $.ajax({
        url: "{% url 'loan_dropdown' %}",
        type: "GET",
        dataType: "json",
        data: $(this).serialize(),
        csrfmiddlewaretoken: '{{ csrf_token }}',
        success: function(data) {
            var dropdown = $('#employee');
            dropdown.empty();

            dropdown.append($('<option selected hidden></option>').attr('value', '').text('Select an Employee'));

            $.each(data, function(key, value) {
                var option = $('<option></option>').attr('value', key).text(value['employee_name']).val(key);

                option.data('email', value['email']);
                option.data('salary', value['salary']);
                option.data('emp-number', value['employee']);  // Set the employee number data attribute
                option.data('have-loan', value['have-loan']);
                option.data('joindate', value['join_date']);

                dropdown.append(option);
            });
        },
        error: function(xhr, status, error) {
            console.error(xhr.responseText);
        }
    });
}







function fillEmployeeDetails() {
    document.getElementById('error-employee').innerText = ''
    var selectedOption = $("#employee option:selected");

    if(selectedOption.data('have-loan') == '1'){
        document.getElementById('error-employee').innerText = 'Employee Already Have a Loan'
        $("#email").val("");
        $("#emp_id").val("");
        $("#salary").val("");
        $("#joindate").val("");
    }else{
        var email = selectedOption.data("email");
    var empNumber = selectedOption.data("emp-number");
    var salary = selectedOption.data("salary");
    var joinDate = selectedOption.data("joindate");
    
    $("#email").val(email);
    $("#emp_id").val(empNumber);
    $("#salary").val(salary);
    $("#joindate").val(joinDate);
    }
    

}



function handleFormSubmission() {
    var paymentMethod = document.getElementById('payment_method').value;
    var salary = parseFloat(document.getElementById('salary').value);
    var monthlyCuttingAmount = parseFloat(document.getElementById('monthly_cutting_amount').value);
    var loan_amount = parseFloat(document.getElementById('loan_amount').value);
    if (paymentMethod === 'percentage_wise') {
        var percentage = parseFloat(document.getElementById('percentage').value);
        var monthlyCuttingAmount = (percentage / 100) * salary;
        document.getElementById('monthly_cutting_amount').value = monthlyCuttingAmount.toFixed(2);
        document.getElementById('error-amount').innerText = 'Changing this value is not Possible';
    } else if (paymentMethod === 'amount_wise') {
        if(isNaN(salary)){
            document.getElementById('error-amount').innerText = 'Please Select an Employee'
            document.getElementById('monthly_cutting_amount').value = ''
        }else if(isNaN(loan_amount)){
            document.getElementById('error-amount').innerText = 'Please Specify loan Amount'
            document.getElementById('monthly_cutting_amount').value = ''
        }else if (monthlyCuttingAmount < 0 || monthlyCuttingAmount > salary ) {
            document.getElementById('error-amount').innerText = "Monthly cutting amount Greater than Salary";
            document.getElementById('monthly_cutting_amount').value = ''
        } else if(monthlyCuttingAmount < 0 || monthlyCuttingAmount > loan_amount) {
            document.getElementById('error-amount').innerText = "Monthly cutting amount Greater than Loan Amount";
            document.getElementById('monthly_cutting_amount').value = ''
        } else {
            document.getElementById('error-amount').innerText = "";
        }
    }
    return true; 
}



// Function to update the monthly cutting amount when percentage changes
function updateMonthlyCuttingAmount() {
    document.getElementById('error-percentage').innerText = "";
    var percentage = parseFloat(document.getElementById('percentage').value);
    var salary = parseFloat(document.getElementById('salary').value);
    var loan_amount = parseFloat(document.getElementById('loan_amount').value);
    if (!isNaN(salary) && !isNaN(loan_amount) && percentage > 0 && percentage <= 100) {
        var monthlyCuttingAmount = (percentage / 100) * salary;
        if (monthlyCuttingAmount > loan_amount){
            document.getElementById('error-percentage').innerText = 'Monthly Cutting Amount Greater Than Loan Amount'
            document.getElementById('percentage').value = ''
        }else{

            document.getElementById('monthly_cutting_amount').value = monthlyCuttingAmount.toFixed(2);
            document.getElementById('error-percentage').innerText = '';
        }
    } else {
        if(isNaN(salary)){
            document.getElementById('error-percentage').innerText = 'Please Select an Employee'
            document.getElementById('percentage').value = ''
        }else if(isNaN(loan_amount)){
            document.getElementById('percentage').value = ''
            document.getElementById('error-percentage').innerText = 'Please Specify Loan Amount'
        }else{
            document.getElementById('monthly_cutting_amount').value = '';
            document.getElementById('error-percentage').innerText = "Invalid Percentage.";
        }
    }
}


            function bankdisplay() {
                var e = document.getElementById("dropId").value;
        
                if (e == 0) {
                    document.getElementById("bank").style.display = 'none'
            document.getElementById("acc_no").value = ''
            document.getElementById("ifsc").value = ''
            document.getElementById("b_name").value = ''
            document.getElementById("branch").value = ''
            document.getElementById("ttype").value = ''
        
                }
                else {
                    document.getElementById("bank").style.display = 'block'
                }
        
            }
            function salFunction() {
                var e = document.getElementById("sal");
                var sal = e.value;
                if (sal == 'Fixed') {
                    document.getElementById("fixed").style.display = 'block'
            document.getElementById("variable").style.display = 'none'
            document.getElementById("amnthr").value = ''
            document.getElementById("hours").value = ''
            document.getElementById("vsalary").value = ''
                }
                else if (sal == 'Variable') {
                    document.getElementById("variable").style.display = 'block'
            document.getElementById("fixed").style.display = 'none'
            document.getElementById("fsalary").value = ''
                }
        
            }
            function calculateAmount() {
                var a = document.getElementById("amnt").value;
        var h = document.getElementById("hours").value;
        var tot = h * a;
        document.getElementById('vsalary').value = tot;
        
            }
        
            function tdsFunction() {
                var e = document.getElementById("tds");
        var sal = e.value;
        if (sal == '1') {
            document.getElementById("tds-div").style.display = 'block'
        }
        else {
            document.getElementById("tds-div").style.display = 'none'
            document.getElementById("pora").value = ''
            document.getElementById("pcnt").value = ''
            document.getElementById("amnt").value = ''
        }
            }
            function tdsFunction2() {
                var e = document.getElementById("pora");
        var sal = e.value;
        if (sal == 'Percentage') {
            document.getElementById("p").style.display = 'block';
            document.getElementById("a").style.display = 'none';
            document.getElementById("amnt").value = ''
        }
        else if (sal == 'Amount') {
            document.getElementById("a").style.display = 'block';
            document.getElementById("p").style.display = 'none'
            document.getElementById("pcnt").value = ''
        }
            }
            function emailvalidate() {
                var email = document.getElementById('email2')
        var error = document.getElementById('error')
        if (!email.value.match(/^[A-Za-z\._\-0-9]*[@][A-Za-z]*[\.][a-z]{2,4}$/)) {
            error.style.fontSize = ".8rem"
            error.innerHTML = "*Please enter a valid email"
            return false;
        }
        error.innerHTML = ""
        return true;
            }
            function phoneValidate(phn, pherror) {
                if (!phn.value.match(/^[6-9]\d{9}$/)) {
            pherror.style.display = "block"
            pherror.style.fontSize = ".8rem"
            pherror.innerHTML = "*Please enter a valid phone number"
            return false;
        }
        pherror.style.display = "none"
        pherror.innerHTML = ""
        return true;
            }
            function empValidation(emp) {
                emp.addEventListener("input", function () {
            emp.value = emp.value.toUpperCase();
        });
            }
            inputvalue = document.getElementById('ifsc')
            inputvalue.addEventListener("input", function () {
                inputvalue.value = inputvalue.value.toUpperCase();
            });
            const inputFields = document.querySelectorAll("input[type='text']");
        
            inputFields.forEach(function (input) {
                input.addEventListener("input", function () {
                    const inputValue = input.value;
                    input.value = inputValue.charAt(0).toUpperCase() + inputValue.slice(1);
                });
            });
        
            document.getElementById("an").addEventListener("input", function () {
                const input = this.value;
                if (input.length > 14) {
                    this.value = input.slice(0, 14); // Truncate the input to 10 characters
                }
            });
            document.getElementById("acc_no").addEventListener("input", function () {
                const input = this.value;
                if (input.length > 15) {
                    this.value = input.slice(0, 15); // Truncate the input to 10 characters
                }
            });
        
            $(document).ready(function () {
                $("#filladdress").on("click", function () {
                    if (this.checked) {
                        $("#adrs1").val($("#padrs1").val());
                        $("#adrs2").val($("#padrs2").val());
        
                    }
                    else {
                        $("#adrs1").val('');
                        $("#adrs2").val('');
                    }
                });
            });

            function clearaddreass(id){
                document.getElementById('filladdress').checked = false
                if(id == 'padrs1' || id == 'padrs2'){

                    $("#adrs1").val('');
                    $("#adrs2").val('');
                }

    }
        </script>
        
            
            
                
                  
  
                 

                    
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
               
                    
                    
                

    


<!-- JavaScript to load content into the modal -->
<script>
    $(document).ready(function() {
        // Function to load content into the modal
        function loadPayrollModalContent() {
            $.get("{% url 'payroll_create' %}", function(data) {
                // Update the content of the modal with the loaded data
                $("#payrollModal .modal-content").html(data);
            });
        }

        // Attach a click event handler to the button
        $("#payrollModalButton").on("click", function() {
            loadPayrollModalContent(); // Load content when the button is clicked
        });
    });
</script>

    

{% endblock %}